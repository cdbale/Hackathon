---
title: "South Korea COVID-19 Patient Trajectory Analysis"
output: github_document
---

<br>

## Overview

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.width = 9,
                      fig.height = 7)
```

First, install and load necessary packages. We use the `tidyverse` package for data manipulation and visualization, the `ggridges` package for plotting densities, and the `patchwork` package for displaying multiple plots together.
```{r message = FALSE}
#install.packages('tidyverse')
#install.packages('patchwork')
library(tidyverse)
library(patchwork)
library(ggridges)
```

This project utilizes data on COVID-19 patients in South Korea. We thank those who have worked to provide the **DS4C: Data Science for COVID-19 in South Korea** [kaggle](https://www.kaggle.com/kimjihoo/coronavirusdataset) and [Github](https://github.com/ThisIsIsaac/Data-Science-for-COVID-19) pages.

The data we use comes from the previously mentioned [kaggle](https://www.kaggle.com/kimjihoo/coronavirusdataset) webpage. See data description [here.](https://www.kaggle.com/kimjihoo/ds4c-what-is-this-dataset-detailed-description)

<br>

The data file `korea_covid_clean.RData` was created using the `korea_data_cleaning.R` [script.](https://github.com/cdbale/Hackathon/blob/master/Code/korea_data_cleaning.R)

<br>
  
Load the cleaned patient information and routes data.
```{r}
load(file = "../Data/korea_data_clean.RData")
```

Create data consisting of `patient_id` and location trajectories (`latitude`/`longitude`) only for individuals with at least 5 observed location points.
```{r}
trajectories <- full %>%
  select(patient_id, latitude, longitude) %>%
  drop_na() %>%
  group_by(patient_id) %>%
  filter(n() > 4)

head(trajectories)
```

We define a trajectory as unique if it differs by at least one location observation from all other observed trajectories. Since individuals have varying trajectory lengths, we take a random sample of points from each trajectory in order to be able to compare them. We will see later that the percentage of unique trajectories increases with the number of sampled points. We compare all tajectories samples and determine what percentage of them are unique.

To perform this calculation, we define a function `trajectory_uniqueness` which takes as inputs the data consisting of three variables: an individual identifier, and latitude and longitude measurements, and the number of times (`nits`) we want to sample `num_points` points from each trajectory and calculate the percentage of unique trajectories. (This function assumes `patient_id` uniquely identifies individuals, and the only other columns are `latitude` and `longitude`).
```{r}
trajectory_uniqueness <- function(trajectory_data, num_points, nits = 1)
{
  split_trajectories <- trajectory_data %>% 
    group_by(patient_id) %>%
    group_split(keep = FALSE)
  
  ntrajectories <- length(split_trajectories)
    
  p_unique <- replicate(n = nits, length(unique(lapply(split_trajectories, 
                                                  function(x) sample_n(x, size = num_points))))/ntrajectories)
  
  return(p_unique)
}
```

To illustrate the privacy risks that exist in this data, we will run the `split_trajectories` function 100 times for sample sizes of one through five points. The percentages generated by this function are saved for later access.
```{r}
up_5d <- map_dfc(1:5, function(x) trajectory_uniqueness(trajectories, num_points = x, nits = 100))
save(up_5d, file = '../Data/pct_unique_5d.RData')
#load('pct_unique_5d.RData')
```

For the purposes of our analysis, we need to add meaningful column names, reshape the data for easy plotting, and add a variable, `specificity` which indicates how many decimal places we had in our `latitude` and `longitude` measurements. For these first results, `latitude` had five decimal places and `longitude` had four. So, we will label this `specificity` as `5`.
```{r}
pvar_names <- c('one', 'two', 'three', 'four', 'five')

colnames(up_5d) <- pvar_names

up_5d <- up_5d %>%
  gather(key = 'num_points', value = 'percent_unique') %>%
  mutate(specificity = 5)
```

We can plot the distributions of unique percentages for each sample size with our original data (five decimal `latitude` and four decimal `longitude`.)
```{r message = FALSE}
ridge_plot <- function(percentage_data, specificity)
{
  p <- percentage_data %>%
  mutate(num_points = factor(num_points, levels = c('one', 'two', 'three', 'four', 'five'))) %>%
  ggplot(aes(x = percent_unique, y = factor(num_points))) +
  labs(x = 'Percent Unique',
       y = 'Number Sampled Points',
       title = paste('Percent Unique Trajectories by Sample Size for', specificity)) +
  geom_density_ridges(rel_min_height = 0.001) +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  xlim(min(percentage_data$percent_unique), 1) +
  coord_cartesian(clip = 'off') +
  theme_ridges()
  
  return(p)
}

ridge_plot(up_5d, '5 Decimal Lat/4 Decimal Long')
```

Now we examine the effects of rounding `latitude` and `longitude` on trajectory uniqueness. In this data, `latitude` has five decimal places and `longitude` has four. We'll start by rounding `latitude` to four decimals. 

We can calculate the maximum distance that someone was 'shifted' by rounding the values of `latitude`. 

[Haversine Formula Here](https://en.wikipedia.org/wiki/Haversine_formula)
[Wikipedia degree distances](https://en.wikipedia.org/wiki/Decimal_degrees)

When rounding to four decimal places, the maximum amount that `latitude` would change would be .00005. This represents a shift of approximately 5.566 meters. This isn't a large shift in location, and if someone was in a sensitive location such as their home, it is likely that this information could still be determined.

Start by rounding latitude so that latitude and longitude are at the same specificity, four decimals, and remeasuring uniqueness.
```{r message = FALSE}
trajectories_4d <- trajectories %>%
  mutate(latitude = round(latitude, digits = 4))

up_4d <- map_dfc(1:5, function(x) trajectory_uniqueness(trajectories_4d, num_points = x, nits = 100))
save(up_4d, file = '../Data/pct_unique_4d.RData')
#load('pct_unique_4d.RData')

colnames(up_4d) <- pvar_names

up_4d <- up_4d %>%
  gather(key = 'num_points', value = 'percent_unique') %>%
  mutate(specificity = 4)

ridge_plot(up_4d, 'Four Decimal Lat/Long')
```

Now, we will round `latitude` and `longitude` simultaneously to three decimals. Rounding from four decimals to three decimals results in a change of ___________ meters depending on distance from the equator.
```{r message = FALSE}
trajectories_3d <- trajectories %>%
  mutate_at(c('latitude', 'longitude'), round, digits = 3)

up_3d <- map_dfc(1:5, function(x) trajectory_uniqueness(trajectories_3d, num_points = x, nits = 100))
save(up_3d, file = '../Data/pct_unique_3d.RData')
#load('pct_unique_3d.RData')

colnames(up_3d) <- pvar_names

up_3d <- up_3d %>%
  gather(key = 'num_points', value = 'percent_unique') %>%
  mutate(specificity = 3)

ridge_plot(up_3d, 'Three Decimal Lat/Long')
```

Now, we will round `latitude` and `longitude` simultaneously to two decimals. Rounding from three decimals to two decimals results in a change of ___________ meters depending on distance from the equator.
```{r message = FALSE}
trajectories_2d <- trajectories %>%
  mutate_at(c('latitude', 'longitude'), round, digits = 2)

up_2d <- map_dfc(1:5, function(x) trajectory_uniqueness(trajectories_2d, num_points = x, nits = 100))
save(up_2d, file = '../Data/pct_unique_2d.RData')
#load('pct_unique_2d.RData')

colnames(up_2d) <- pvar_names

up_2d <- up_2d %>%
  gather(key = 'num_points', value = 'percent_unique') %>%
  mutate(specificity = 2)

ridge_plot(up_2d, 'Two Decimal Lat/Long')
```

Now, we will round `latitude` and `longitude` simultaneously to one decimal. Rounding from two decimals to one decimal results in a change of ___________ meters depending on distance from the equator.
```{r message = FALSE}
trajectories_1d <- trajectories %>%
  mutate_at(c('latitude', 'longitude'), round, digits = 1)

up_1d <- map_dfc(1:5, function(x) trajectory_uniqueness(trajectories_1d, num_points = x, nits = 100))
save(up_1d, file = '../Data/pct_unique_1d.RData')
#load('pct_unique_1d.RData')

colnames(up_1d) <- pvar_names

up_1d <- up_1d %>%
  gather(key = 'num_points', value = 'percent_unique') %>%
  mutate(specificity = 1)

ridge_plot(up_1d, 'One Decimal Lat/Long')
```

Now, we will round `latitude` and `longitude` simultaneously to zero decimals. Rounding from one decimal to zero decimals results in a change of ___________ meters depending on distance from the equator.
```{r message = FALSE}
trajectories_0d <- trajectories %>%
  mutate_at(c('latitude', 'longitude'), round, digits = 0)

up_0d <- map_dfc(1:5, function(x) trajectory_uniqueness(trajectories_0d, num_points = x, nits = 100))
save(up_0d, file = '../Data/pct_unique_0d.RData')
#load('pct_unique_0d.RData')

colnames(up_0d) <- pvar_names

up_0d <- up_0d %>%
  gather(key = 'num_points', value = 'percent_unique') %>%
  mutate(specificity = 0)

ridge_plot(up_0d, 'Zero Decimal Lat/Long')
```

```{r}
full_pd <- up_5d %>%
  bind_rows(up_4d, up_3d, up_2d, up_1d, up_0d)

full_pd %>%
  mutate(specificity = factor(specificity, levels = c('0', '1', '2', '3', '4', '5')),
         num_points = factor(num_points, levels = c('one', 'two', 'three', 'four', 'five'))) %>%
  ggplot(aes(x = factor(specificity), y = percent_unique, fill = factor(num_points))) +
  geom_boxplot() +
  labs(x = 'Number Decimal Places (Lat/Long)',
       y = '% Unique Trajectories',
       fill = '# Lat/Long Points\n',
       title = 'Uniqueness for Varying Trajectory Sample Size and Location Specificity For COVID-19 Patients') +
  scale_y_continuous(breaks = 0.1 * 0:10, labels = seq(0, 100, 10)) +
  scale_fill_discrete(labels = c('One', 'Two', 'Three', 'Four', 'Five'),
                      guide = guide_legend(reverse = TRUE))
```
